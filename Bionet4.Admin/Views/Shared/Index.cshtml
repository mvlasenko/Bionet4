@using Bionet4.Data.Properties
@using Bionet4.Data.Contracts
@using Bionet4.Admin.Helpers

@model IPagedCollection

@{
    var controller = HttpContext.Current.Request.RequestContext.RouteData.Values["controller"].ToString();

    ViewBag.Title = controller;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>@controller</h2>

<div style="padding-bottom: 10px;">
    <button class="btn btn-primary create-item">@Resources.CreateNew</button>
</div>

<div>
    <table class="table" id="grid">

        <thead>
            <tr>
                @foreach (string propName in ViewBag.ListFieldHeaders)
                {
                    <th>@propName</th>
                }
                <th></th>
            </tr>
        </thead>

        <tbody></tbody>

    </table>
</div>

<div id="pager" style="margin: 6px;">
</div>

<!-- Modal -->
<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="modal-content"></div>
    </div>
</div>
<!-- Modal - 2nd level -->
<div class="modal fade" id="modal2" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content" id="modal2-content"></div>
    </div>
</div>

<!-- loading spinner -->
<div class="modal fade" id="loader" role="dialog" style="top: 300px; left: 300px;">
    <div class="modal-dialog">
        <div class="loader"></div>
    </div>
</div>

@section scripts {

    @Styles.Render("~/Content/datetimepicker")
    @Scripts.Render("~/bundles/datetimepicker")

    @Styles.Render("~/Content/dropzone")
    @Scripts.Render("~/bundles/dropzone")

    @Styles.Render("~/Content/jQuery-File-Upload")
    @Scripts.Render("~/bundles/jQuery-File-Upload")

    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">

    function InitModal() {

        $('.edit-item').unbind();
        $('.edit-item').click(function() {
            var url = "@Url.Content("~/")@controller/UpdatePartial";
            var id = $(this).attr('data-id');
            $.get(url + '/' + id, function(data) {
                $('#modal-content').html(data);

                $('#modal').modal('show');
                jQuery.validator.unobtrusive.parse('#frmModal');

                AddAsterisk();
                InitDatePicker();
                RefreshParagraphs();
                RefreshAlbumDetails();
            });
        });

        $('.create-item').unbind();
        $('.create-item').click(function() {
            var url = "@Url.Content("~/")@controller/CreatePartial";
            $.get(url, function(data) {
                $('#modal-content').html(data);

                $('#modal').modal('show');
                jQuery.validator.unobtrusive.parse('#frmModal');

                AddAsterisk();
                InitDatePicker();
            });
        });

        $('.delete-item').unbind();
        $('.delete-item').click(function () {

            if (confirm('@Resources.DeleteConfirm'))
            {
                var url = "@Url.Content("~/")@controller/DestroyPartial";
                var id = $(this).attr('data-id');
                $.get(url + '/' + id, function(data) {

                    totalCount = data.totalCount;

                    var pageSize = @Model.PageSize;
                    var pageIndex = Math.floor((totalCount - 1) / pageSize) + 1;
                    if (pageIndex <= currentPageIndex)
                    {
                        currentPageIndex = pageIndex;
                        InitPager(currentPageIndex);
                    }

                    RefreshGrid(currentPageIndex);

                });
            }
        });
    }

    function InitParagraphModal() {

        $('.create-paragraph').unbind();
        $('.create-paragraph').click(function () {
            var url = "@Url.Content("~/")Paragraphs/CreateParagraph?ArticleId=" + $("#Id").val();
            $.get(url, function(data) {
                $('#modal2-content').html(data);

                $('#modal2').modal('show');
                jQuery.validator.unobtrusive.parse('#frmModal2');

                AddAsterisk();
            });
        });

        $('.edit-paragraph').unbind();
        $('.edit-paragraph').click(function() {
            var url = "@Url.Content("~/")Paragraphs/UpdatePartial";
            var id = $(this).attr('data-id');
            $.get(url + '/' + id, function(data) {
                $('#modal2-content').html(data);

                $('#modal2').modal('show');
                jQuery.validator.unobtrusive.parse('#frmModal2');

                AddAsterisk();
            });
        });

        $('.delete-paragraph').unbind();
        $('.delete-paragraph').click(function () {
            if (confirm('@Resources.DeleteConfirm'))
            {
                var url = "@Url.Content("~/")Paragraphs/DestroyPartial";
                var id = $(this).attr('data-id');
                $.get(url + '/' + id, function(data) {

                    RefreshParagraphs();

                });
            }
        });
    }

    function InitAlbumDetailModal() {

        $('.create-ad').unbind();
        $('.create-ad').click(function () {
            var url = "@Url.Content("~/")AlbumDetails/CreateAlbumDetail?AlbumId=" + $("#Id").val();
            $.get(url, function(data) {
                $('#modal2-content').html(data);

                $('#modal2').modal('show');
                jQuery.validator.unobtrusive.parse('#frmModal2');

                AddAsterisk();
            });
        });

        $('.edit-ad').unbind();
        $('.edit-ad').click(function() {
            var url = "@Url.Content("~/")AlbumDetails/UpdatePartial";
            var id = $(this).attr('data-id');
            $.get(url + '/' + id, function(data) {
                $('#modal2-content').html(data);

                $('#modal2').modal('show');
                jQuery.validator.unobtrusive.parse('#frmModal2');

                AddAsterisk();
            });
        });

        $('.delete-ad').unbind();
        $('.delete-ad').click(function () {
            if (confirm('@Resources.DeleteConfirm'))
            {
                var url = "@Url.Content("~/")AlbumDetails/DestroyPartial";
                var id = $(this).attr('data-id');
                $.get(url + '/' + id, function(data) {

                    RefreshAlbumDetails();

                });
            }
        });
    }

    function InitPager(pageIndex) {

        var pageSize = @Model.PageSize;

        $('#pager').empty();

        for (i = 1; i <= (totalCount - 1) / pageSize + 1; i++)
        {
            $('#pager').append('<button class="btn btn-primary page-item ' + (i == pageIndex ? "disabled" : "") + '" style="margin: 4px;" data-id="' + i +'">' + i + '</button>');
        }

        $('.page-item').click(function () {
            currentPageIndex = $(this).attr('data-id');

            $('.page-item').removeClass("disabled");
            $(this).addClass("disabled");

            RefreshGrid(currentPageIndex);
        });
    }

    function RefreshGrid(pageIndex) {
        $('#loader').modal('show');
        var url = "@Url.Content("~/")@controller/GetPagedList/" + pageIndex;
        $.ajax({
            type: 'GET',
            dataType: 'Json',
            url: url,
            success: function(data) {

                $('table#grid TBODY').empty();

                $.each(data, function (idx, item) {
                    var row = "<tr>";

                var val = '';
                @foreach (Bionet4.Admin.ViewModels.FieldInfo prop in ViewBag.ListFields)
                {
                    if (prop.UIHint == "_Image")
                    {
                        @Html.Raw("row += (item.ImageID ? '<td><img src=\"/admin/Images/Image/' + item.ImageID + '?width=100\" width=100 height=100 /></td>' : '<td><i class=\"fa ' + (item.FaIcon ? item.FaIcon : 'fa-question-circle') + ' fa-4x\"></i></td>');\n");
                    }
                    else if(prop.Type == "DateTime")
                    {
                        @Html.Raw("row += '<td>' + ((new Date(parseInt(item." + prop.Name + ".substr(6)))).toLocaleString()) + '</td>';\n");
                    }
                    else
                    {
                        @Html.Raw("row += '<td>' + (item." + prop.Name + " || '') + '</td>';\n");
                    }
                }
                    row += "<td align='right'><button class='btn btn-primary edit-item' data-id='" + item.Id + "'>@Resources.Edit</button> <button class='btn btn-primary delete-item' data-id='" + item.Id + "'>@Resources.Delete</button></td>";
                    row += "</tr>";

                    $('table#grid TBODY').append(row);
                });

                $('#loader').modal('hide');

                InitModal();
            },
            processData: false,
            async: true
        });
    }

    function RefreshParagraphs() {
        var url = "@Url.Content("~/")Paragraphs/GetParagraphs?ArticleId=" + $("#Id").val();
        $.ajax({
            type: 'GET',
            dataType: 'Json',
            url: url,
            success: function(data) {

                $('table#gridParagraphs TBODY').empty();

                $.each(data, function (idx, item) {
                    var row = "<tr>";
                    row += (item.ImageID ? '<td><img src="/admin/Images/Image/' + item.ImageID + '?width=100" width=100 height=100 /></td>' : '<td><i class="fa ' + (item.FaIcon ? item.FaIcon : 'fa-question-circle') + ' fa-4x"></i></td>');
                    row += '<td>' + item.Name + '</td>';
                    row += '<td>' + item.Description + '</td>';
                    row += "<td align='right'><button type='button' class='btn btn-primary edit-paragraph' data-id='" + item.Id + "'>@Resources.Edit</button> <button type='button' class='btn btn-primary delete-paragraph' data-id='" + item.Id + "'>@Resources.Delete</button></td>";
                    row += "</tr>";

                    $('table#gridParagraphs TBODY').append(row);
                });

                InitParagraphModal();
            },
            processData: false,
            async: true
        });
    }

    function RefreshAlbumDetails() {
        var url = "@Url.Content("~/")AlbumDetails/GetAlbumDetails?AlbumId=" + $("#Id").val();
        $.ajax({
            type: 'GET',
            dataType: 'Json',
            url: url,
            success: function(data) {

                $('table#gridAlbumDetails TBODY').empty();

                $.each(data, function (idx, item) {
                    var row = "<tr>";
                    row += (item.ImageID ? '<td><img src="/admin/Images/Image/' + item.ImageID + '?width=100" width=100 height=100 /></td>' : '<td><i class="fa fa-question-circle fa-4x"></i></td>');
                    row += '<td>' + item.Name + '</td>';
                    row += "<td align='right'><button type='button' class='btn btn-primary edit-ad' data-id='" + item.Id + "'>@Resources.Edit</button> <button type='button' class='btn btn-primary delete-ad' data-id='" + item.Id + "'>@Resources.Delete</button></td>";
                    row += "</tr>";

                    $('table#gridAlbumDetails TBODY').append(row);
                });

                InitAlbumDetailModal();
            },
            processData: false,
            async: true
        });
    }

    function AddAsterisk() {
        $('input[type=text]').each(function() {
            var req = $(this).attr('data-val-required');
            if (undefined != req) {
                var label = $('label[for="' + $(this).attr('id') + '"]');
                var text = label.text();
                if (text.length > 0 && text.indexOf('*') === -1) {
                    label.append('<span style="color:red"> *</span>');
                }
            }
        });
    }

    function onCreateSuccess(data) {

        totalCount = data.totalCount;

        var pageSize = @Model.PageSize;
        var pageIndex = Math.floor((totalCount - 1) / pageSize) + 1;
        if (pageIndex != currentPageIndex)
        {
            currentPageIndex = pageIndex;
            InitPager(currentPageIndex);
        }

        RefreshGrid(currentPageIndex);
    }

    function InitDatePicker() {

        $('.datetimepicker').datetimepicker({
            format: '@UIHelper.GetDateTimeFormat()'
        });

        $('.datepicker').datetimepicker({
            format: '@UIHelper.GetDateFormat()'
        });
    }

    var totalCount = @Model.TotalCount ;
    var currentPageIndex = 1;

    $(document).ready(function() {

        InitModal();

        InitPager(currentPageIndex);

        RefreshGrid(currentPageIndex);
    });

    </script>
}